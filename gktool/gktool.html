<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

	<head>
		<meta http-equiv="content-type" content="text/html;charset=utf-8" />
		<script src="http://www.gourdianknot.com/assets/gk/javascript/game/gkIso.js" type="text/javascript"></script>
		
		<script type="text/javascript">
			function init() {
				console.log("init");
			}

			var gkToolContext = new gkToolContextDef();

			function gkToolContextDef() {
				this.svgMap = new Object();
				this.assembleMap = new Object();
				this.animateMap = new Object();
				this.selectedAssembleId = "none";
				this.liSvgPrefix = "lis_";
				this.liAssemblePrefix = "lias_";
				this.liAnimatePrefix = "lian_";
				this.assemblePrefix = "asm_";
				this.animiatePrefix = "ani_";
				this.animatePiecePrefix = "anip_";
				this.selectPrefix = "sel_";
				this.groupAnimatePrefix = "gani_";
				this.nextId = 1;
				delete this.currentTransformXId;
				delete this.currentTransformYId;
				delete this.currentTransformAngleId;
				delete this.currentTransformStack;
				delete this.currentTransformId;
				delete this.currentTransformIndex1;
				delete this.currentTransformIndex2;
				delete this.currentTransformIndex3;
				this.currentMouseMoveX = 0;
				this.currentMouseMoveY = 0;
				this.mouseDown = false;
				this.mouseTwiceDown = false;
			}

			function gkToolSvgEntryDef(fileName, rawSvgData) {
				this.fileName = fileName;
				this.rawSvgData = rawSvgData;
			}

			function gkToolAssembleEntryDef(id, assembleObject) {
				this.id = id;
				this.assembleObject = assembleObject;
			}

			function gkToolAnimateEntryDef(id, animateObject) {
				this.id = id;
				this.animateObject = animateObject;
			}

		function init() {
			var browserCompatible = document.getElementById("browserCompatible");
			if (window.File && window.FileReader && window.FileList && window.Blob && window.URL && window.URL.createObjectURL) {
				browserCompatible.innerHTML = "your browser is compatible";
			} else {
				browserCompatible.innerHTML = "your browser is not compatible";
			}

			document.getElementById("files").addEventListener('change', handleFileSelect, false);
		}

		function handleFileSelect(event) {
			var i
			files = event.target.files;
			for (i = 0;i < files.length;i++) {
				var localFile = files[i];

				var reader = new FileReader();
				reader.onprogress = doFileProgress;
				reader.onerror = doFileError;
				reader.readAsText(localFile, "UTF-8");

				console.log("localFile.name: " + localFile.name);

				reader.onload = (
						function (fileName) {
						return function (evt) {
						gotFile(fileName,evt.target.result);
						};
					}(localFile.name)
						);
			}
		}

		function doFileProgress(evt) {
			console.log("progress: loaded: " + evt.loaded + " total: " + evt.total);
		}

		function doFileError(evt) {
			console.log("error: " + evt.target.error.name);
		}

		function gotFile(fileName, rawSvgData) {
			console.log("got file: " + fileName);
			if (fileName.length > 4) {
				var suffix = fileName.substring(fileName.length - 3, fileName.length);
				suffix = suffix.toLowerCase();
				if (suffix == "svg") {
					var shortFileName = fileName.substring(0, fileName.length - 4);
					gotSvgFile(shortFileName, rawSvgData);
				}
			}
			if (fileName.length > 5) {
				var suffix = fileName.substring(fileName.length - 4, fileName.length);
				suffix = suffix.toLowerCase();
				if (suffix == "json") {
					var shortFileName = fileName.substring(0, fileName.length -5);
					gotJsonFile(shortFileName, rawSvgData);
				}
			}
		}

		function gotSvgFile(id, rawSvgData) {

			var svgEntry = new gkToolSvgEntryDef(id, rawSvgData);
			gkToolContext.svgMap[svgEntry.fileName] = svgEntry

			var oldEntry = document.getElementById(id);
			if (oldEntry != undefined) {
				oldEntry.parentNode.removeChild(oldEntry);
			}

			var g = gkIsoCreateSvgObject(rawSvgData);
			g.setAttribute("id",id);
			//g.setAttributeNS(gkIsoContext.svgNameSpace,"id",id);
			var isoXYZ = new GkIsoXYZDef(0, 0, 0);
			gkIsoSetSvgObjectPosition(g, isoXYZ);
			var field = document.getElementById("piecesGroup");
			field.appendChild(g)

			var oldLi = document.getElementById(gkToolContext.liSvgPrefix + id)
			if (oldLi != undefined) {
				oldLi.parentNode.removeChild(oldLi);
			}
			var newLi = document.createElement("li");
			newLi.setAttribute("id",gkToolContext.liSvgPrefix + id);
			newLi.innerHTML = id;

			var newSubmit = document.createElement("input");
			newSubmit.setAttribute("type","submit");
			newSubmit.setAttribute("value","del");
			newSubmit.onclick = function() { doDeleteSvg(id) };
			newLi.appendChild(newSubmit);

			var svgObjects = document.getElementById("svgObjects");
			svgObjects.appendChild(newLi);
		}

		function gotJsonFile(id, rawJsonData) {
			var jsonObject = JSON.parse(rawJsonData, null);
			if (jsonObject != undefined) {
				if (jsonObject.type != undefined) {
					if (jsonObject.type == "assemble") {
						gotAssembleFile(id, jsonObject);
						doSelectAssemble(id);
						doRunAssemble(id);
					}
					if (jsonObject.type == "animate") {
						gotAnimateFile(id, jsonObject);
						doSelectAnimate(id);
					}
				}
			}
		}

		function gotAssembleFile(id, assembleObject) {
console.log("got assemble file: " + id);
			var oldEntry = document.getElementById(gkToolContext.assemblePrefix + id);
			if (oldEntry != undefined) {
				oldEntry.parentNode.removeChild(oldEntry);
			}

			var oldLi = document.getElementById(gkToolContext.liAssemblePrefix + id)
			if (oldLi != undefined) {
				oldLi.parentNode.removeChild(oldLi);
			}
			var newLi = document.createElement("li");
			newLi.setAttribute("id",gkToolContext.liAssemblePrefix + id);
			newLi.innerHTML = id;

			var newSubmit = document.createElement("input");
			newSubmit.setAttribute("type","submit");
			newSubmit.setAttribute("value","del");
			newSubmit.onclick = function() { doDeleteAssemble(id) };
			newLi.appendChild(newSubmit);

			newSubmit = document.createElement("input");
			newSubmit.setAttribute("type","submit");
			newSubmit.setAttribute("value","run");
			newSubmit.onclick = function() { doRunAssemble(id) };
			newLi.appendChild(newSubmit);

			newSubmit = document.createElement("input");
			newSubmit.setAttribute("type","submit");
			newSubmit.setAttribute("value","save");
			newSubmit.onclick = function() { doSaveAssemble(id) };
			newLi.appendChild(newSubmit);

			newSubmit = document.createElement("input");
			newSubmit.setAttribute("type","submit");
			newSubmit.setAttribute("value","select");
			newSubmit.onclick = function() { doSelectAssemble(id) };
			newLi.appendChild(newSubmit);

			var assembleObjects = document.getElementById("assembleObjects");
			assembleObjects.appendChild(newLi);

			var assembleEntry = new gkToolAssembleEntryDef(id, assembleObject);
			gkToolContext.assembleMap[id] = assembleEntry;
		}

		function gotAnimateFile(id, animateObject) {
console.log("got animate file: " + id);
			var oldEntry = document.getElementById(gkToolContext.animatePrefix + id);
			if (oldEntry != undefined) {
				oldEntry.parentNode.removeChild(oldEntry);
			}

			var oldLi = document.getElementById(gkToolContext.liAnimatePrefix + id)
			if (oldLi != undefined) {
				oldLi.parentNode.removeChild(oldLi);
			}
			var newLi = document.createElement("li");
			newLi.setAttribute("id",gkToolContext.liAnimatePrefix + id);
			newLi.innerHTML = id;

			var newSubmit = document.createElement("input");
			newSubmit.setAttribute("type","submit");
			newSubmit.setAttribute("value","del");
			newSubmit.onclick = function() { doDeleteAnimate(id) };
			newLi.appendChild(newSubmit);

			newSubmit = document.createElement("input");
			newSubmit.setAttribute("type","submit");
			newSubmit.setAttribute("value","run");
			newSubmit.onclick = function() { doRunAnimate(id) };
			newLi.appendChild(newSubmit);

			newSubmit = document.createElement("input");
			newSubmit.setAttribute("type","submit");
			newSubmit.setAttribute("value","save");
			newSubmit.onclick = function() { doSaveAnimate(id) };
			newLi.appendChild(newSubmit);

			newSubmit = document.createElement("input");
			newSubmit.setAttribute("type","submit");
			newSubmit.setAttribute("value","select");
			newSubmit.onclick = function() { doSelectAnimate(id) };
			newLi.appendChild(newSubmit);

			var animateObjects = document.getElementById("animateObjects");
			animateObjects.appendChild(newLi);

			var animateEntry = new gkToolAnimateEntryDef(id, animateObject);
			gkToolContext.animateMap[id] = animateEntry;
		}

		function doDeleteSvg(id) {
			var oldEntry = document.getElementById(id);
			if (oldEntry != undefined) {
				oldEntry.parentNode.removeChild(oldEntry);
			}

			oldEntry = document.getElementById(gkToolContext.liSvgPrefix + id);
			if (oldEntry != undefined) {
				oldEntry.parentNode.removeChild(oldEntry);
			}

			delete gkToolContext.svgMap[id];
		}

		function doDeleteAssemble(id) {
			var oldEntry = document.getElementById(gkToolContext.liAssemblePrefix + id);
			if (oldEntry != undefined) {
				oldEntry.parentNode.removeChild(oldEntry);
			}

			delete gkToolContext.assembleMap[id];
		}

		function doDeleteAnimate(id) {
			var oldEntry = document.getElementById(gkToolContext.liAnimatePrefix + id);
			if (oldEntry != undefined) {
				oldEntry.parentNode.removeChild(oldEntry);
			}

			delete gkToolContext.animateMap[id];
		}

		function doRunAssemble(id) {
//console.log("doRunAssemble: " + id);
			clearAssembleGroup();
			var assembleEntry = gkToolContext.assembleMap[id];

			if (assembleEntry != undefined) {
				//clearSvg();
				assembleSvg(assembleEntry.id, assembleEntry.assembleObject);
			}
		}

		function doRunAnimate(id) {
			var animateEntry = gkToolContext.animateMap[id];

			var assembleEntry = gkToolContext.assembleMap[gkToolContext.selectedAssembleId];
			if (assembleEntry != undefined) {
				doSelectAssemble(gkToolContext.selectedAssembleId);
				doRunAssemble(gkToolContext.selectedAssembleId);
			}

			if (animateEntry != undefined) {
				animateSvg(animateEntry.id, animateEntry.animateObject);
			}
		}

		function doSaveAssemble(id) {
			var assembleEntry = gkToolContext.assembleMap[id];
			if (assembleEntry != undefined) {
				var serialized = [JSON.stringify(assembleEntry.assembleObject)]
				var b = new Blob(serialized, { type: "application/octet-binary"});
				var objectURL = window.URL.createObjectURL(b);

				var downloadAssemble = document.getElementById("downloadAssemble");
				downloadAssemble.href = objectURL;
			}
		}

		function doSaveAnimate(id) {
			var animateEntry = gkToolContext.animateMap[id];
			if (animateEntry != undefined) {
				var serialized = [JSON.stringify(animateEntry.animateObject)]
				var b = new Blob(serialized, { type: "application/octet-binary"});
				var objectURL = window.URL.createObjectURL(b);

				var downloadAnimate = document.getElementById("downloadAnimate");
				downloadAnimate.href = objectURL;
			}
		}

		function clearAssembleGroup() {
			var assembleGroup = document.getElementById("assembleGroup");

			var childNodes = assembleGroup.childNodes
			var i;
			for (i = 0;i < childNodes.length;i++) {
				var node = childNodes[i];
				node.parentNode.removeChild(node);
			}
		}

		function clearSvg() {
			for (var prop in gkToolContext.svgMap) {
				var oldEntry = document.getElementById(prop);
				if (oldEntry != undefined) {
					oldEntry.parentNode.removeChild(oldEntry);
				}
			}
		}

		function animateSvg(id, animateObject) {
			console.log("animateSvg timeList.length: " + animateObject.timeList.length);

			animateSvgTimeList(id, animateObject.timeList);
//			for (var prop in animateObject) {
//				if (prop == "timeList") {
//					animateSvgTimeList(id, animateObject[prop]);
//				}
//			}
		}

		function animateSvgTimeList(id, timeList) {
			console.log("animateSvgTimeList");

			var i
			var timeSum = 0
			for (i = 0;i < timeList.length;i++) {
console.log("i: " + i);
				var time = timeList[i].time;
				timeSum += time;
				var piecesList = timeList[i].piecesList;

				setTimeout("animateSvgDoSingle(\"" + id + "\", \"" + i + "\")", timeSum);
			}
		}

		function animateSvgDoSingle(id, index) {
//			console.log("animateSvgDoSingle " + id + " " + index);
			var animateEntry = gkToolContext.animateMap[id];
			var timeList = animateEntry.animateObject.timeList;

			var piecesList = timeList[index].piecesList;

			var i;
			for (i = 0;i < piecesList.length;i++) {
				console.log("i: " + i + " id: " + piecesList[i].piece.id);
				var transformList = piecesList[i].piece.transformList;
				animateSvgApplySingleTransform(id, piecesList[i].piece.id, transformList);
			}
		}

		function animateSvgApplySingleTransform(id, pieceId, transformList) {
			console.log("animateSvgApplySingleTransform id: " + id + " pieceId: " + pieceId + " transformations count: " + transformList.length);

			var assembleGroup = document.getElementById("assembleGroup");

			var node = findAssembleGroupAnimateG(pieceId);
			if (node != undefined) {
console.log("found node: " + node.id);
				var transformObject = new Object();
				transformObject.transform = "";
				assembleSvgTransformList(transformList, transformObject);
console.log("apply transform to found node: " + transformObject.transform);
				node.setAttribute("transform",transformObject.transform);
			}
		}

		function findAssembleGroupAnimateG(pieceId) {
			var assembleGroup = document.getElementById("assembleGroup");

			return findAssembleGroupAnimateGRecurse(assembleGroup, pieceId, 0);
		}

		function findAssembleGroupAnimateGRecurse(node, pieceId, tab) {
			var result;
//console.log("children: " + node.childNodes.length + " tab: " + tab + " id: " + node.id);
			var i;
			for (i = 0;i < node.childNodes.length;i++) {
//console.log("i: " + i + " id: " + node.childNodes[i].id);
				if (node.childNodes[i].id != undefined) {
					if (node.childNodes[i].id == (gkToolContext.groupAnimatePrefix + pieceId)) {
						return node.childNodes[i]
					}
}
				result = findAssembleGroupAnimateGRecurse(node.childNodes[i], pieceId, tab + 1);
				if (result != undefined) {
					return result;
				}
			}
		}

		function assembleSvg(id, assembleObject) {
			assembleGroup = document.getElementById("assembleGroup");

			for (var prop in assembleObject) {
				if (prop == "group") {
					assembleSvgGroup(assembleObject[prop], assembleGroup);
				}
				if (prop == "piecesList") {
					assembleSvgPiecesList(assembleObject[prop], assembleGroup);
				}
			}
		}

		function assembleSvgGroup(group, currentGroup) {
			var childGroup = document.createElementNS(gkIsoContext.svgNameSpace,"g");
			var subChildGroup = document.createElementNS(gkIsoContext.svgNameSpace,"g");
			childGroup.setAttribute("id",group.id);
			subChildGroup.setAttribute("id",gkToolContext.groupAnimatePrefix + group.id);
			childGroup.appendChild(subChildGroup);
			currentGroup.appendChild(childGroup);
			for (var prop in group) {
				if (prop == "transformList") {
					var transformObject = new Object();
					transformObject.transform = "";
					assembleSvgTransformList(group[prop], transformObject);
					childGroup.setAttribute("transform",transformObject.transform);
				}
				if (prop == "piecesList") {
					assembleSvgPiecesList(group[prop], subChildGroup);
				}
			}
		}

		function assembleSvgPiecesList(piecesList, currentGroup) {
			var childGroup = document.createElementNS(gkIsoContext.svgNameSpace,"g");
			currentGroup.appendChild(childGroup);
			var i;
			for (i = 0;i < piecesList.length;i++) {
				var pieceEntry = piecesList[i];

				for (var prop in pieceEntry) {
					if (prop == "group") {
						assembleSvgGroup(pieceEntry[prop], childGroup);
					}
					if (prop == "piece") {
						assembleSvgPiece(pieceEntry[prop], childGroup);
					}
				}
			}
		}

		function assembleSvgPiece(piece, currentGroup) {
//			console.log("piece: " + piece.id);

			//var childGroup = document.createElement("g");

			var transformG = document.createElementNS(gkIsoContext.svgNameSpace,"g");
			transformG.id = gkToolContext.animatePiecePrefix + piece.id;
			currentGroup.appendChild(transformG);

			var childGroup = document.createElementNS(gkIsoContext.svgNameSpace,"g");
			transformG.appendChild(childGroup);

			if (piece.transformList != undefined) {
				var transformObject = new Object();
				transformObject.transform = "";
				assembleSvgTransformList(piece.transformList, transformObject);

				childGroup.setAttribute("transform",transformObject.transform);
				//childGroup.setAttributeNS(gkIsoContext.svgNameSpace,"transform",transformObject.transform);
			}

			var id = piece.id;
			var ref = document.createElementNS(gkIsoContext.svgNameSpace,"use");
			ref.setAttributeNS(gkIsoContext.xlinkNameSpace,"href","#" + id);
			//var ref = document.createElementNS("http://www.w3.org/2000/svg","use");
			//ref.setAttributeNS("http://www.w3.org/1999/xlink","href","#" + id);
			childGroup.appendChild(ref);
		}

		function assembleSvgTransformList(transformList, transformObject) {
			var i;
			for (i = 0;i < transformList.length;i++) {
				assembleSvgTransform(transformList[i].transform, transformObject);
			}
		}

		function assembleSvgTransform(transform, transformObject) {
			var tran = "";

			if (transform.type == "translate") {
				tran = "translate(" + transform.x + "," + transform.y + ")";
			}
			if (transform.type == "rotate") {
				tran = "rotate(" + transform.angle + "," + transform.x + "," + transform.y + ")";
			}
			if (transform.type == "scale") {
				tran = "scale(" + transform.x + "," + transform.y + ")";
			}
			if (transform.type == "skewX") {
				tran = "skewX(" + transform.x + ")";
			}
			if (transform.type == "skewY") {
				tran = "skewY(" + transform.y + ")";
			}
			if (transformObject.transform != "") {
				transformObject.transform = transformObject.transform + " ";
			}

			transformObject.transform = transformObject.transform + tran;
		}

		function doCreateAssemble() {
			var id
			var createAssembleId = document.getElementById("createAssembleId");
			id = createAssembleId.value;
			var jsonObject = { "type": "assemble", "group": { "id": "new", "transformList": [] } };
			gotAssembleFile(id, jsonObject);

			doSelectAssemble(id);
			doRunAssemble(id);
		}

		function doCreateAnimate() {
			var id
			var createAnimateId = document.getElementById("createAnimateId");
			id = createAnimateId.value;
			var jsonObject = { "type": "animate", "timeList": [ ] };
			gotAnimateFile(id, jsonObject);

			doSelectAnimate(id);
		}

		function doSelectAssemble(id) {
			gkToolContext.selectedAssembleId = id;
			var assembleEntry = gkToolContext.assembleMap[id];
			if (assembleEntry != undefined) {
				clearAssembleList();
				setAssembleListId(id);
			}
		}

		function doSelectAnimate(id) {
			var animateEntry = gkToolContext.animateMap[id];
			if (animateEntry != undefined) {
				clearAnimateList();
				setAnimateListId(id);
			}
		}

		function clearAssembleList() {
			var assembleList = document.getElementById("assembleList");

			var childNodes = assembleList.childNodes
			var i;
			for (i = (childNodes.length - 1);i >= 0;i--) {
				var node = childNodes[i];
				node.parentNode.removeChild(node);
			}
		}

		function clearAnimateList() {
			var animateList = document.getElementById("animateList");

			var childNodes = animateList.childNodes
			var i;
			for (i = (childNodes.length - 1);i >= 0;i--) {
				var node = childNodes[i];
				node.parentNode.removeChild(node);
			}
		}

		function setAssembleListId(id) {
			var newUl = document.createElement("ul");

			var newLi = document.createElement("li");
			newUl.appendChild(newLi);

			var newSpan = document.createElement("span");
			newSpan.innerHTML = id;
			newLi.appendChild(newSpan);

//			var newSubmit = document.createElement("input");
//			newSubmit.setAttribute("type","submit");
//			newSubmit.setAttribute("value","select");
//			newSubmit.onclick = function() { addAssembleGroupControlsSet(id, "") };
//			newLi.appendChild(newSubmit);

			var assembleList = document.getElementById("assembleList");
			assembleList.appendChild(newUl);

			var assembleEntry = gkToolContext.assembleMap[id];
			var node = assembleEntry.assembleObject;

			var stack = new Array();

			addAssembleNodeSelect(id, node, stack, newUl);
		}

		function setAnimateListId(id) {
			console.log("setAnimateListId");
			var newUl = document.createElement("ul");

			var newLi = document.createElement("li");
			newUl.appendChild(newLi);

			var newSpan = document.createElement("span");
			newSpan.innerHTML = id;
			newLi.appendChild(newSpan);

			var newSubmit = document.createElement("input");
			newSubmit.setAttribute("type","submit");
			newSubmit.setAttribute("value","select");
			newSubmit.onclick = function() { addAnimateGroupControlsSet(id) };
			newLi.appendChild(newSubmit);

			var animateList = document.getElementById("animateList");
			animateList.appendChild(newUl);

			var animateEntry = gkToolContext.animateMap[id];
			var node = animateEntry.animateObject;

			var stack = new Array();

			addAnimateNodeSelect(id, node, stack, newUl);
		}

		function addAnimateNodeSelect(id, node, stack, newUl) {
console.log("addAnimateNodeSelect timeList.length: " + node.timeList.length);

			var i;

			for (i = 0;i < node.timeList.length;i++) {
				var newLi = document.createElement("li");
				newUl.appendChild(newLi);

				var newSpan = document.createElement("span");
				newSpan.innerHTML = node.timeList[i].time;
				newLi.appendChild(newSpan);

				var newSubmit = document.createElement("input");
				newSubmit.setAttribute("type","submit");
				newSubmit.setAttribute("value","select");
				//newSubmit.onclick = function() { addAnimateTimeEntryControlsSet(id, i.toString()) };
				setOnclickAddAnimateTimeEntryControlsSet(newSubmit,id,i);
				newLi.appendChild(newSubmit);

				var newSubUl = document.createElement("ul");
				newLi.appendChild(newSubUl);

				var piecesList = node.timeList[i].piecesList;
				var j;
				for (j = 0;j < piecesList.length;j++) {
					var newSubLi = document.createElement("li");
					newSubUl.appendChild(newSubLi);

					var newSubSpan = document.createElement("span");
					newSubSpan.innerHTML = piecesList[j].piece.id;
					newSubLi.appendChild(newSubSpan);

					var newSubmit = document.createElement("input");
					newSubmit.setAttribute("type","submit");
					newSubmit.setAttribute("value","select");
					setOnclickAddAnimatePieceEntryControlsSet(newSubmit,id,i,j);
					newSubLi.appendChild(newSubmit);

					var newSubSubUl = document.createElement("ul");
					newSubLi.appendChild(newSubSubUl);

					var k;
					for (k = 0;k < piecesList[j].piece.transformList.length;k++) {
						var transformEntry = piecesList[j].piece.transformList[k]
						var newSubSubLi = document.createElement("li");
						newSubSubUl.appendChild(newSubSubLi);

						var newSubSubSpan = document.createElement("span");
						newSubSubSpan.innerHTML = transformEntry.transform.type + " " + k;
						newSubSubLi.appendChild(newSubSubSpan);

						var newSubSubmit = document.createElement("input");
						newSubSubmit.setAttribute("type","submit");
						newSubSubmit.setAttribute("value","select");
						setOnclickAddAnimateTransformEntryControlsSet(newSubSubmit,id,i,j,k);
						newSubSubLi.appendChild(newSubSubmit);
					}
				}
			}
		}

		function setOnclickAddAnimateTimeEntryControlsSet(newSubmit,id,i) {
			newSubmit.onclick = function() { addAnimateTimeEntryControlsSet(id, i) };
		}

		function setOnclickAddAnimatePieceEntryControlsSet(newSubmit,id,i,j) {
			newSubmit.onclick = function() { addAnimatePieceEntryControlsSet(id, i, j) };
		}

		function setOnclickAddAnimateTransformEntryControlsSet(newSubmit, id, i, j, k) {
			newSubmit.onclick = function() { addAnimateTransformEntryControlsSet(id, i, j, k) };
		}

		function addAssembleNodeSelect(id, node, stack, newUl) {
			if (node.group != undefined) {
				stack.push("group");

				var newLi = document.createElement("li");
				newLi.setAttribute("id",gkToolContext.liSvgPrefix + id);
				newUl.appendChild(newLi);

				var newSpan = document.createElement("span");
				newSpan.innerHTML = getStackSpacing(stack, 0) + "group: " + node.group.id;
				newLi.appendChild(newSpan);

				var newSubmit = document.createElement("input");
				newSubmit.setAttribute("type","submit");
				newSubmit.setAttribute("value","select");
console.log("adding stack: " + stack.toString());

				var localStack = stack.toString();
				newSubmit.onclick = function() { addAssembleGroupControlsSet(id, localStack) };
				newLi.appendChild(newSubmit);
				stack.pop();
			}
			if (node.transformList != undefined) {
				stack.push("transformList");
				addTransformListControlsSelect(id, node.transformList, stack, -1, newUl);
				var i
				for (i = 0;i < node.transformList.length;i++) {
					stack.push(i);
					stack.push("transform");
					addTransformListControlsSelect(id, node.transformList, stack, i, newUl);
					stack.pop();
					stack.pop();
				}
				stack.pop();
			}
			if (node.piecesList != undefined) {
				stack.push("piecesList");
				addPiecesListControlsSelect(id, node.piecesList, stack, -1, newUl);
				var i
				for (i = 0;i < node.piecesList.length;i++) {
					stack.push(i);

					if (node.piecesList[i].piece != undefined) {
						stack.push("piece");
						addPiecesListControlsSelect(id, node.piecesList[i], stack, i, newUl);
						stack.pop();
					}
					if (node.piecesList[i].group != undefined) {
//						stack.push("group");
						addAssembleNodeSelect(id, node.piecesList[i], stack, newUl);
//						stack.pop();
					}

					stack.pop();
				}
				stack.pop();
			}

			if (node.group != undefined) {
				stack.push("group");
				addAssembleNodeSelect(id, node.group, stack, newUl);
				stack.pop();
			}
		}

		function addAssembleGroupControlsSet(id, stack) {
console.log("addAssembleGroupControlsSet " + id + " <" + stack + ">");
			doClearControls();

			var currentControls = document.getElementById("currentControls");
			var node = getNodeFromStack(id, stack);

			var newSubmit = document.createElement("input");
			newSubmit.setAttribute("type","text");
			newSubmit.setAttribute("id","groupId");
			newSubmit.setAttribute("value",node.id);
			currentControls.appendChild(newSubmit);
			var localStack_id = stack.toString();
			newSubmit.onchange = function() { doAssembleControlChangeGroupId(id, localStack_id) };

//			newSubmit = document.createElement("input");
//			newSubmit.setAttribute("type","submit");
//			newSubmit.setAttribute("value","new group");
//			newSubmit.onclick = function() { doAssembleControlNewGroup(id) };
//			currentControls.appendChild(newSubmit);

//			var newBr = document.createElement("br");
//			currentControls.appendChild(newBr);

			newSubmit = document.createElement("input");
			newSubmit.setAttribute("type","submit");
			newSubmit.setAttribute("value","new pieces list");

			var localStack = stack.toString();
			newSubmit.onclick = function() { doAssembleControlNewPiecesList(id, localStack); };
			currentControls.appendChild(newSubmit);

			newSubmit = document.createElement("input");
			newSubmit.setAttribute("type","submit");
			newSubmit.setAttribute("value","new transform list");
			var localStack_trl = stack.toString();
			newSubmit.onclick = function() { doAssembleControlNewTransformList(id, localStack_trl) };
			currentControls.appendChild(newSubmit);
		}

		function addAnimateGroupControlsSet(id) {
console.log("addAnimateGroupControlsSet " + id);
			doClearControls();

			var currentControls = document.getElementById("currentControls");

			newSubmit = document.createElement("input");
			newSubmit.setAttribute("type","submit");
			newSubmit.setAttribute("value","new Time List Entry");
			newSubmit.onclick = function() { doAssembleControlNewTimeListEntry(id) };
			currentControls.appendChild(newSubmit);

			var newBr = document.createElement("br");
			currentControls.appendChild(newBr);
		}

		function addAnimateTimeEntryControlsSet(id, index) {
			console.log("addAnimateTimeEntryControlsSet: " + id + " " + index);
			doClearControls();

			var currentControls = document.getElementById("currentControls");

			var newSpan = document.createElement("span");
			newSpan.innerHTML = "time delay:"
			currentControls.appendChild(newSpan);

			var newSubmit = document.createElement("input");
			newSubmit.setAttribute("type","text");
			newSubmit.setAttribute("id","animateTimeDelay");
			var timeEntry = getAnimateTimeEntry(id, index);
			newSubmit.setAttribute("value", timeEntry.time);
			currentControls.appendChild(newSubmit);
			newSubmit.onchange = function() { doAnimateControlChangeTime(id, index) };

			newSubmit = document.createElement("input");
			newSubmit.setAttribute("type","submit");
			newSubmit.setAttribute("value","del");
			newSubmit.onclick = function() { doAnimateControlDeleteTimeEntry(id, index) };
			currentControls.appendChild(newSubmit);

			newSubmit = document.createElement("input");
			newSubmit.setAttribute("type","submit");
			newSubmit.setAttribute("value","new pieces list");
			newSubmit.onclick = function() { doAnimateControlNewPieceEntry(id, index) };
			currentControls.appendChild(newSubmit);

			animateSvgDoSingle(id, index);
		}

		function doAnimateControlChangeTime(id, index) {
			var timeEntry = getAnimateTimeEntry(id, index);
			var timeInput = document.getElementById("animateTimeDelay");
			timeEntry.time = parseInt(timeInput.value);

			doSelectAnimate(id);
		}

		function doAnimateControlNewPieceEntry(id, index) {
			var timeEntry = getAnimateTimeEntry(id, index);

			var pieceEntry = new Object();
			pieceEntry.piece = new Object();
			pieceEntry.piece.id = "unknown";
			pieceEntry.piece.transformList = new Array();
			timeEntry.piecesList.push(pieceEntry);

			doSelectAnimate(id);
		}

		function getAnimateTimeEntry(id, index) {
			var animateEntry = gkToolContext.animateMap[id];

			return animateEntry.animateObject.timeList[index];
		}

		function getAnimatePieceEntry(id, index1, index2) {
			var animateEntry = gkToolContext.animateMap[id];

			return animateEntry.animateObject.timeList[index1].piecesList[index2];
		}

		function getAnimateTransformEntry(id, index1, index2, index3) {
			var animateEntry = gkToolContext.animateMap[id];

			return animateEntry.animateObject.timeList[index1].piecesList[index2].piece.transformList[index3];
		}

		function addAnimatePieceEntryControlsSet(id, index1, index2) {
			console.log("addAnimatePieceEntryControlsSet: " + id + " " + index1 + " " + index2);
			doClearControls();
			var pieceEntry = getAnimatePieceEntry(id, index1, index2);

			var currentControls = document.getElementById("currentControls");
			var newSelect = document.createElement("select");
			newSelect.id = "selectPieceId";
			currentControls.appendChild(newSelect);
			newSelect.onchange = function() { doAnimateControlChangePieceId(id, index1, index2) };

			if (pieceEntry.piece.id == "unknown") {
				var newOption = document.createElement("option");
				newOption.value = "unknown";
				newOption.innerHTML = "unknown";
				newSelect.appendChild(newOption);
			}

			groupIdList = getAssembleGroupIdList(id);

			var newOption;
			var i;
			for (i = 0;i < groupIdList.length;i++) {
				var newOption = document.createElement("option");
				newOption.value = groupIdList[i];
				newOption.innerHTML = groupIdList[i];
				
				if (groupIdList[i] == pieceEntry.piece.id) {
					newOption.selected = "selected"
				}
				newSelect.appendChild(newOption);
			}

//			var newOption;
//			for (var prop in gkToolContext.svgMap) {
//				var newOption = document.createElement("option");
//				newOption.value = prop;
//				newOption.innerHTML = prop;
//				if (prop == pieceEntry.piece.id) {
//					newOption.selected = "selected"
//				}
//				newSelect.appendChild(newOption);
//			}

			var newSubmit = document.createElement("input");
			newSubmit.setAttribute("type","submit");
			newSubmit.setAttribute("value","del");
			newSubmit.onclick = function() { doAnimateControlDeletePiece(id, index1, index2) };
			currentControls.appendChild(newSubmit);

			var newSubmit = document.createElement("input");
			newSubmit.setAttribute("type","submit");
			newSubmit.setAttribute("value","new transform");
			newSubmit.onclick = function() { doAnimateControlNewTransform(id, index1, index2) };
			currentControls.appendChild(newSubmit);

			animateSvgDoSingle(id, index1);
		}

		function getAssembleGroupIdList(id) {
			var assembleEntry = gkToolContext.assembleMap[gkToolContext.selectedAssembleId];
			var node = assembleEntry.assembleObject;
			var groupIdList = new Array();

			getAssembleGroupIdListRecurse(node, groupIdList);

			return groupIdList;
		}

		function getAssembleGroupIdListRecurse(assembleObject, groupIdList) {
			for (var prop in assembleObject) {
				if (prop == "group") {
					getAssembleGroupIdListRecurseGroup(assembleObject, groupIdList);
				}
				if (prop == "piecesList") {
					getAssembleGroupIdListRecursePiecesList(assembleObject, groupIdList);
				}
			}
		}

		function getAssembleGroupIdListRecurseGroup(node, groupIdList) {
			groupIdList.push(node.group.id);
			if (node.group.piecesList != undefined) {
				getAssembleGroupIdListRecursePiecesList(node.group, groupIdList);
			}
		}

		function getAssembleGroupIdListRecursePiecesList(node, groupIdList) {
			var i;
			for (i = 0;i < node.piecesList.length;i++) {
				if (node.piecesList[i].group != undefined) {
					getAssembleGroupIdListRecurseGroup(node.piecesList[i], groupIdList);
				}
			}
		}

		function doAnimateControlNewTransform(id, index1, index2) {
			console.log("doAnimateControlNewTransform " + id + " " + index1 + " " + index2);
			var pieceEntry = getAnimatePieceEntry(id, index1, index2);

			var transformEntry = new Object();
			transformEntry.transform = new Object();
			transformEntry.transform.type = "translate";
			transformEntry.transform.x = 0;
			transformEntry.transform.y = 0;
			pieceEntry.piece.transformList.push(transformEntry);

			doSelectAnimate(id);
		}

		function doAnimateControlDeleteTimeEntry(id, index) {
			console.log("doAnimateControlDeleteTimeEntry " + id + " " + index);

			var animateEntry = gkToolContext.animateMap[id];

			var i
			for (i = (index + 1);i < animateEntry.animateObject.timeList.length;i++) {
				animateEntry.animateObject.timeList[i - 1] = animateEntry.animateObject.timeList[i];
			}

			animateEntry.animateObject.timeList.pop();

			doClearControls();
			doSelectAnimate(id);
		}

		function doAnimateControlDeletePiece(id, index1, index2) {
			console.log("doAnimateControlDeletePiece " + id + " " + index1 + " " + index2);
			var timeEntry = getAnimateTimeEntry(id, index1);

			var i
			for (i = (index2 + 1);i < timeEntry.piecesList.length;i++) {
				timeEntry.piecesList[i - 1] = timeEntry.piecesList[i];
			}

			timeEntry.piecesList.pop();

			doClearControls();
			doSelectAnimate(id);
		}

		function doAnimateControlChangePieceId(id, index1, index2) {
			console.log("doAnimateControlChangePieceId " + index1 + " " + index2);

			var pieceSelect = document.getElementById("selectPieceId");

			var pieceEntry = getAnimatePieceEntry(id, index1, index2);
			pieceEntry.piece.id = pieceSelect.value

			doSelectAnimate(id);
		}

		function addAnimateTransformEntryControlsSet(id, index1, index2, index3) {
			console.log("addAnimateTransformEntryControlsSet: " + id + " " + index1 + " " + index2 + " " + index3);
			var transformEntry = getAnimateTransformEntry(id, index1, index2, index3);

			doClearControls();

			var currentControls = document.getElementById("currentControls");

			var newSelect = document.createElement("select");
			newSelect.id = gkToolContext.selectPrefix + gkToolContext.nextId;
			gkToolContext.nextId += 1;
console.log("type id: " + newSelect.id);
			var id1 = newSelect.id;
			newSelect.onchange = function() { doAnimateControlChangeTransform(id, index1, index2, index3, id1, "type") };
			currentControls.appendChild(newSelect);

			var newOption = document.createElement("option");
			newOption.value = "translate";
			newOption.innerHTML = "translate";
			newSelect.appendChild(newOption);

			newOption = document.createElement("option");
			newOption.value = "rotate";
			newOption.innerHTML = "rotate";
			if (transformEntry.transform.type == "rotate") {
				newOption.selected = "selected";
			}
			newSelect.appendChild(newOption);

			newOption = document.createElement("option");
			newOption.value = "scale";
			newOption.innerHTML = "scale";
			if (transformEntry.transform.type == "scale") {
				newOption.selected = "selected";
			}
			newSelect.appendChild(newOption);

			newOption = document.createElement("option");
			newOption.value = "skewX";
			newOption.innerHTML = "skewX";
			if (transformEntry.transform.type == "skewX") {
				newOption.selected = "selected";
			}
			newSelect.appendChild(newOption);

			newOption = document.createElement("option");
			newOption.value = "skewY";
			newOption.innerHTML = "skewY";
			if (transformEntry.transform.type == "skewY") {
				newOption.selected = "selected";
			}
			newSelect.appendChild(newOption);

			var newSpan = document.createElement("span");
			newSpan.innerHTML = "x";
			currentControls.appendChild(newSpan);

			var newSubmit = document.createElement("input");
			newSubmit.setAttribute("type","text");
			newSubmit.setAttribute("value",transformEntry.transform.x);
			newSubmit.id = gkToolContext.selectPrefix + gkToolContext.nextId;
			gkToolContext.currentTransformXId = newSubmit.id;
console.log("x id: " + newSubmit.id);
			var id_x = newSubmit.id;
			gkToolContext.nextId += 1;
			var id2 = newSubmit.id;
			newSubmit.onchange = function() { doAnimateControlChangeTransform(id, index1, index2, index3, id2, "x") };
			currentControls.appendChild(newSubmit);

			var newSpan = document.createElement("span");
			newSpan.innerHTML = "y";
			currentControls.appendChild(newSpan);

			var newSubmit = document.createElement("input");
			newSubmit.setAttribute("type","text");
			newSubmit.setAttribute("value",transformEntry.transform.y);
			newSubmit.id = gkToolContext.selectPrefix + gkToolContext.nextId;
			gkToolContext.currentTransformYId = newSubmit.id;
console.log("y id: " + newSubmit.id);
			var id_y = newSubmit.id;
			gkToolContext.nextId += 1;
			var id3 = newSubmit.id;
			newSubmit.onchange = function() { doAnimateControlChangeTransform(id, index1, index2, index3, id3, "y") };
			currentControls.appendChild(newSubmit);

			var newSpan = document.createElement("span");
			newSpan.innerHTML = "angle";
			currentControls.appendChild(newSpan);

			var newSubmit = document.createElement("input");
			newSubmit.setAttribute("type","text");
			newSubmit.setAttribute("value",transformEntry.transform.angle);
			newSubmit.id = gkToolContext.selectPrefix + gkToolContext.nextId;
			gkToolContext.currentTransformAngleId = newSubmit.id;
console.log("angle id: " + newSubmit.id);
			var id_angle = newSubmit.id;
			gkToolContext.nextId += 1;
			var id4 = newSubmit.id;
			newSubmit.onchange = function() { doAnimateControlChangeTransform(id, index1, index2, index3, id4, "angle") };
			currentControls.appendChild(newSubmit);

			var newSubmit = document.createElement("input");
			newSubmit.setAttribute("type","submit");
			newSubmit.setAttribute("value","del");
			newSubmit.onclick = function() { doAnimateControlDeleteTransformEntry(id, index1, index2, index3) };
			currentControls.appendChild(newSubmit);
			gkToolContext.currentTransformId = id;
			gkToolContext.currentTransformIndex1 = index1;
			gkToolContext.currentTransformIndex2 = index2;
			gkToolContext.currentTransformIndex3 = index3;

			animateSvgDoSingle(id, index1);
		}

		function doAnimateControlChangeTransform(id, index1, index2, index3, submitId, changeType) {
			console.log("doAnimateControlChangeTransform " + id + " " + index1 + "," + index2 + "," + index3 + " submitId: " + submitId);

			var comp = document.getElementById(submitId);
			var value = comp.value;
console.log("comp value: " + value);

			//var node = getNodeFromStack(id, stack);
			var transformEntry = getAnimateTransformEntry(gkToolContext.currentTransformId, gkToolContext.currentTransformIndex1, gkToolContext.currentTransformIndex2, gkToolContext.currentTransformIndex3);

//dumpNode("got node for transform: ", node);
			if (changeType == "type") {
				transformEntry.transform.type = value;
			}
			if (changeType == "angle") {
				transformEntry.transform.angle = value;
			}
			if (changeType == "x") {
				transformEntry.transform.x = value;
			}
			if (changeType == "y") {
				transformEntry.transform.y = value;
			}
			doSelectAnimate(id);
//			doRunAnimate(id);
			animateSvgDoSingle(id, index1);
		}

		function doAnimateControlDeleteTransformEntry(id, index1, index2, index3) {
			console.log("doAnimateControlDeleteTransformEntry " + id + " " + index1 + "," + index2 + "," + index3);

			var pieceEntry = getAnimatePieceEntry(id, index1, index2);

			var i
			for (i = (index3 + 1);i < pieceEntry.piece.transformList.length;i++) {
				pieceEntry.piece.transformList[i - 1] = pieceEntry.piece.transformList[i];
			}

			pieceEntry.piece.transformList.pop();

			doClearControls();
			doSelectAnimate(id);
			doRunAnimate(id);
		}

		function addAssemblePiecesControlsSet(id, stack, index) {
console.log("addAssemblePiecesControlsSet " + id + " <" + stack + "> index: " + index);
			doClearControls();

			var currentControls = document.getElementById("currentControls");

			if (index == -1) {
				var newSubmit = document.createElement("input");
				newSubmit.setAttribute("type","submit");
				newSubmit.setAttribute("value","new piece");
				var localStack = stack.toString();
				newSubmit.onclick = function() { doAssembleControlNewPiece(id, localStack, index) };
				currentControls.appendChild(newSubmit);

				var newSubmit = document.createElement("input");
				newSubmit.setAttribute("type","submit");
				newSubmit.setAttribute("value","new group");
				var localStack_gr = stack.toString();
				newSubmit.onclick = function() { doAssembleControlNewGroup(id, localStack_gr, index) };
				currentControls.appendChild(newSubmit);
			} else {
				var node = getNodeFromStack(id, stack);
//console.log("got node: node.id: " + node.id);
				var newSelect = document.createElement("select");
				currentControls.appendChild(newSelect);

				if (node.id == "unknown") {
					var newOption = document.createElement("option");
					newOption.value = "unknown";
					newOption.innerHTML = "unknown";
					newSelect.appendChild(newOption);
				}

				var newOption;
				for (var prop in gkToolContext.svgMap) {
					var newOption = document.createElement("option");
					newOption.value = prop;
					newOption.innerHTML = prop;
					if (prop == node.id) {
						newOption.selected = "selected"
					}
					newSelect.appendChild(newOption);
				}
			
				var localStack_id;
				localStack_id = stack.toString();
				newSelect.id = gkToolContext.selectPrefix + gkToolContext.nextId;
				gkToolContext.nextId += 1;
				newSelect.onchange = function() { doAssembleControlChangePieceId(id, localStack_id, index, newSelect.id) };

				currentControls.appendChild(newSelect);

				if (node.transformList == undefined) {
					var newSubmit = document.createElement("input");
					newSubmit.setAttribute("type","submit");
					newSubmit.setAttribute("value","create transform list");
					var localStack_tr = stack.toString();
					newSubmit.onclick = function() { doAssembleControlNewTransformList(id, localStack_tr) };
					currentControls.appendChild(newSubmit);
				}

				var newSubmit = document.createElement("input");
				newSubmit.setAttribute("type","submit");
				newSubmit.setAttribute("value","del");
				var localStack_del = dropTwoOffStack(stack.toString());
				newSubmit.onclick = function() { doAssembleControlDeletePiece(id, localStack_del, index) };
				currentControls.appendChild(newSubmit);

				var newSubmit = document.createElement("input");
				newSubmit.setAttribute("type","submit");
				newSubmit.setAttribute("value","move up");
				var localStack_move_up = dropTwoOffStack(stack.toString());
				newSubmit.onclick = function() { doAssembleControlMovePiece(id, localStack_move_up, index, -1) };
				currentControls.appendChild(newSubmit);

				var newSubmit = document.createElement("input");
				newSubmit.setAttribute("type","submit");
				newSubmit.setAttribute("value","move down");
				var localStack_move_down = dropTwoOffStack(stack.toString());
				newSubmit.onclick = function() { doAssembleControlMovePiece(id, localStack_move_down, index, 1) };
				currentControls.appendChild(newSubmit);

			}
		}

		function doAssembleControlChangePieceId(id, stack, index, selectId) {
			console.log("doAssembleControlChangePieceId " + stack);

			var node = getNodeFromStack(id, stack);

			var select = document.getElementById(selectId);

			node.id = select.value;

			doSelectAssemble(id);
			doRunAssemble(id);
		}

		function doAssembleControlChangeGroupId(id, stack) {
			console.log("doAssembleControlChangeGruopId " + stack);

			var node = getNodeFromStack(id, stack);

			var inputId = document.getElementById("groupId");

			node.id = inputId.value;

			doSelectAssemble(id);
			doRunAssemble(id);
		}

		function doAssembleControlChangeTransform(id, stack, index, selectId, changeType) {
			console.log("doAssembleControlChangeTransform selectId: " + selectId + " stack: " + stack + " index: " + index);

			var comp = document.getElementById(selectId);
			var value = comp.value;
console.log("comp value: " + value);

			var node = getNodeFromStack(id, stack);

dumpNode("got node for transform: ", node);
			if (changeType == "type") {
				node.type = value;
			}
			if (changeType == "angle") {
				node.angle = value;
			}
			if (changeType == "x") {
				node.x = value;
			}
			if (changeType == "y") {
				node.y = value;
			}
			doRunAssemble(id);
		}

		function doAssembleControlDeletePiece(id, stack, index) {
			console.log("doAssembleControlDeletePiece " + stack);

			var node = getNodeFromStack(id, stack);

			var i

			if (node.length < 2) {
				node.pop();
			} else {
				for (i = index; i < (node.length - 1);i++) {
					node[i] = node[i + 1];
				}
				node.pop();
			}

			doClearControls();
			doSelectAssemble(id);
			doRunAssemble(id);
		}

		function doAssembleControlMovePiece(id, stack, index, moveDir) {
			console.log("doAssembleControlMovePiece " + stack);

			var node = getNodeFromStack(id, stack);

			if (node.length > (index + moveDir)) {
				if ((index + moveDir) >= 0) {
					var n1
					n1 = node[index];
					node[index] = node[index + moveDir];
					node[index + moveDir] = n1;
console.log("fix this stack: " + stack);
					addAssemblePiecesControlsSet(id, stack + "," + (index + moveDir) + ",piece", index + moveDir);
					doSelectAssemble(id);
					doRunAssemble(id);
				}
			}
		}

		function doAssembleControlDeleteTransformEntry(id, stack, index) {
			console.log("doAssembleControlDeleteTransformEntry " + stack);

			var node = getNodeFromStack(id, stack);


			dumpNode("got node for delete transform: ", node);

			var i

			if (node.length < 2) {
				node.pop();
			} else {
				for (i = index; i < (node.length - 1);i++) {
					node[i] = node[i + 1];
				}
				node.pop();
			}

			doClearControls();
			doSelectAssemble(id);
			doRunAssemble(id);
		}

		function doAssembleControlNewTransformList(id, stack) {
			console.log("doAssembleControlNewTransformList " + stack);

			var node = getNodeFromStack(id, stack);

			node.transformList = new Array();

			doSelectAssemble(id);
			doRunAssemble(id);
		}

		function doAssembleControlNewTimeListEntry(id) {
			console.log("doAssembleControlNewTimeListEntry");

			var animateEntry = gkToolContext.animateMap[id];

			var timeListEntry = new Object();
			timeListEntry.time = 0;
			timeListEntry.piecesList = new Array();
			animateEntry.animateObject.timeList.push(timeListEntry);

			doSelectAnimate(id);
		}

		function getNodeFromStack(id, stack) {
			console.log("getNodeFromStack: " + id + " " + stack);
			var assembleEntry = gkToolContext.assembleMap[id];

			var stackWords = stack.split(",")

			var node = assembleEntry.assembleObject;

			for (var i = 0;i < stackWords.length;i++) {
console.log("getNodeFromStack " + i + " " + stackWords[i]);
				if (/^\d+$/.test(stackWords[i])) {
					var j
					j = parseInt(stackWords[i]);
					node = node[j];
				} else {
					node = node[stackWords[i]];
				}
			}

			return node;
		}

		function dumpNode(string, node) {

			if (node == undefined) {
				console.log("dumpNode undefined");
			} else {
				var nodeType = " type of: " + typeof(node) + " " + Object.prototype.toString.call(node);
				var nodeHas = "";
				if (node.hasOwnProperty("group")) {
					nodeHas = " has group";
				}
				if (node.hasOwnProperty("id")) {
					nodeHas = " has id of: " + node.id;
				}
				if (node.hasOwnProperty("transformList")) {
					nodeHas = " has transformList";
				}
				if (node.hasOwnProperty("piecesList")) {
					nodeHas = " has piecesList";
				}
				if (node.hasOwnProperty("piece")) {
					nodeHas = " has piece";
				}
				if (node.hasOwnProperty("transform")) {
					nodeHas = " has transform";
				}
				if (node.hasOwnProperty("x")) {
					nodeHas = " has x: " + node.x;
				}
				if (node.hasOwnProperty("y")) {
					nodeHas = " has y: " + node.y;
				}

				console.log("dumpNode " + string + nodeType + " " + nodeHas);
			}
		}

		function addAssembleTransformControlsSet(id, stack, index) {
console.log("addAssembleTransformControlsSet " + id + " <" + stack + "> index: " + index);
			doClearControls();

			var currentControls = document.getElementById("currentControls");
			var node = getNodeFromStack(id, stack);

			if (index == -1) {
				var newSubmit = document.createElement("input");
				newSubmit.setAttribute("type","submit");
				newSubmit.setAttribute("value","new transform");
				var localStack = stack.toString();
				newSubmit.onclick = function() { doAssembleControlNewTransformEntry(id, localStack, index) };
				currentControls.appendChild(newSubmit);

			} else {
//dumpNode("in transform: ", node);
				var newSelect = document.createElement("select");
				var localStack = stack.toString();
				newSelect.id = gkToolContext.selectPrefix + gkToolContext.nextId;
				gkToolContext.nextId += 1;
console.log("type id: " + newSelect.id);
				newSelect.onchange = function() { doAssembleControlChangeTransform(id, localStack, index, newSelect.id, "type") };
				currentControls.appendChild(newSelect);

				var newOption = document.createElement("option");
				newOption.value = "translate";
				newOption.innerHTML = "translate";
				newSelect.appendChild(newOption);

				newOption = document.createElement("option");
				newOption.value = "rotate";
				newOption.innerHTML = "rotate";
				if (node.type == "rotate") {
					newOption.selected = "selected";
				}
				newSelect.appendChild(newOption);

				newOption = document.createElement("option");
				newOption.value = "scale";
				newOption.innerHTML = "scale";
				if (node.type == "scale") {
					newOption.selected = "selected";
				}
				newSelect.appendChild(newOption);

				newOption = document.createElement("option");
				newOption.value = "skewX";
				newOption.innerHTML = "skewX";
				if (node.type == "skewX") {
					newOption.selected = "selected";
				}
				newSelect.appendChild(newOption);

				newOption = document.createElement("option");
				newOption.value = "skewY";
				newOption.innerHTML = "skewY";
				if (node.type == "skewY") {
					newOption.selected = "selected";
				}
				newSelect.appendChild(newOption);

				var newSpan = document.createElement("span");
				newSpan.innerHTML = "x";
				currentControls.appendChild(newSpan);

				var newSubmit = document.createElement("input");
				newSubmit.setAttribute("type","text");
				newSubmit.setAttribute("value",node.x);
				var localStack = stack.toString();
				newSubmit.id = gkToolContext.selectPrefix + gkToolContext.nextId;
				gkToolContext.currentTransformXId = newSubmit.id;
console.log("x id: " + newSubmit.id);
				var id_x = newSubmit.id;
				gkToolContext.nextId += 1;
				newSubmit.onchange = function() { doAssembleControlChangeTransform(id, localStack, index, id_x, "x") };
				currentControls.appendChild(newSubmit);

				var newSpan = document.createElement("span");
				newSpan.innerHTML = "y";
				currentControls.appendChild(newSpan);

				var newSubmit = document.createElement("input");
				newSubmit.setAttribute("type","text");
				newSubmit.setAttribute("value",node.y);
				var localStack = stack.toString();
				newSubmit.id = gkToolContext.selectPrefix + gkToolContext.nextId;
				gkToolContext.currentTransformYId = newSubmit.id;
console.log("y id: " + newSubmit.id);
				var id_y = newSubmit.id;
				gkToolContext.nextId += 1;
				newSubmit.onchange = function() { doAssembleControlChangeTransform(id, localStack, index, id_y, "y") };
				currentControls.appendChild(newSubmit);

				var newSpan = document.createElement("span");
				newSpan.innerHTML = "angle";
				currentControls.appendChild(newSpan);

				var newSubmit = document.createElement("input");
				newSubmit.setAttribute("type","text");
				newSubmit.setAttribute("value",node.angle);
				var localStack = stack.toString();
				newSubmit.id = gkToolContext.selectPrefix + gkToolContext.nextId;
				gkToolContext.currentTransformAngleId = newSubmit.id;
console.log("angle id: " + newSubmit.id);
				var id_angle = newSubmit.id;
				gkToolContext.nextId += 1;
				newSubmit.onchange = function() { doAssembleControlChangeTransform(id, localStack, index, id_angle, "angle") };
				currentControls.appendChild(newSubmit);

				var newSubmit = document.createElement("input");
				newSubmit.setAttribute("type","submit");
				newSubmit.setAttribute("value","del");
				var localStack_del = dropTwoOffStack(stack.toString());
				newSubmit.onclick = function() { doAssembleControlDeleteTransformEntry(id, localStack_del, index) };
				currentControls.appendChild(newSubmit);
				var localStackSave = stack.toString();
				gkToolContext.currentTransformStack = localStackSave;
				gkToolContext.currentTransformId = id;
			}
		}

		function dropTwoOffStack(localStack) {
			var index = localStack.lastIndexOf(",");
			if (index == -1) {
				return localStack;
			}
			localStack = localStack.slice(0,index);

			var index = localStack.lastIndexOf(",");
			if (index == -1) {
				return localStack;
			}
			localStack = localStack.slice(0,index);

			return localStack;
		}

		function addTransformListControlsSelect(id, node, stack, index, newUl) {
			var newLi = document.createElement("li");
			newLi.setAttribute("id",gkToolContext.liSvgPrefix + id);
			newUl.appendChild(newLi);

			var newSpan = document.createElement("span");
			newSpan.innerHTML = getStackSpacing(stack, index) + "transformList";
			if (index != -1) {
				newSpan.innerHTML += " " + index;
			}
			newLi.appendChild(newSpan);

			var newSubmit = document.createElement("input");
			newSubmit.setAttribute("type","submit");
			newSubmit.setAttribute("value","select");

			var localStack = stack.toString();
			newSubmit.onclick = function() { addAssembleTransformControlsSet(id, localStack, index) };
			newLi.appendChild(newSubmit);
		}

		function addPiecesListControlsSelect(id, node, stack, index, newUl) {
			var newLi = document.createElement("li");
			newLi.setAttribute("id",gkToolContext.liSvgPrefix + id);
			newUl.appendChild(newLi);

			var newSpan = document.createElement("span");
			if (index == -1) {
				newSpan.innerHTML = getStackSpacing(stack, index) + "pieces list";
			} else {
				newSpan.innerHTML = getStackSpacing(stack, index) + "piece " + node.piece.id + " " + index;
			}
			newLi.appendChild(newSpan);

			var newSubmit = document.createElement("input");
			newSubmit.setAttribute("type","submit");
			newSubmit.setAttribute("value","select");

			var localStack = stack.toString();
			newSubmit.onclick = function() { addAssemblePiecesControlsSet(id, localStack, index) };
			newLi.appendChild(newSubmit);

			if (index != -1) {
				if (node.piece.transformList != undefined) {
					stack.push("transformList");
					addTransformListControlsSelect(id, node.piece.transformList, stack, -1, newUl);
					var i
					for (i = 0;i < node.piece.transformList.length;i++) {
						stack.push(i);
						stack.push("transform");
						addTransformListControlsSelect(id, node.piece.transformList, stack, i, newUl);
						stack.pop();
						stack.pop();
					}
					stack.pop();
				}
			}
		}

		function getStackSpacing(stack, index) {
			var spacing = "";
			var i;
			for (i = 0;i < stack.length;i++) {
				spacing = spacing + ".";
			}
			if (index != -1) {
				spacing = spacing + ".";
			}
			return spacing;
		}

		function doAssembleControlNewGroup(id, stack) {
			console.log("doAssembleControlNewGroup " + stack);

			var node = getNodeFromStack(id, stack);

			var piecesListEntry = new Object();
			var group = new Object();
			group.id = "new";
			group.transformList = [];
			piecesListEntry.group = group;

			node.push(piecesListEntry);

			doSelectAssemble(id);
			doRunAssemble(id);
		}

		function doAssembleControlNewPiecesList(id, stack) {
			console.log("doAssembleControlNewPiecesList");
			//var assembleEntry = gkToolContext.assembleMap[id];
			var node = getNodeFromStack(id, stack);

			node.piecesList = new Array();
			doSelectAssemble(id);
			doRunAssemble(id);
		}

		function doAssembleControlNewPiece(id, stack, index) {
			console.log("doAssembleControlNewPiece " + stack.toString() + " " + stack.length);

			var node = getNodeFromStack(id, stack);

			var pieceListEntry = new Object();
			var piece = new Object();
			piece.id = "unknown";
			pieceListEntry.piece = piece
			node.push(pieceListEntry);

			doSelectAssemble(id);
			doRunAssemble(id);
		}

		function doAssembleControlNewTransformEntry(id, stack, index) {
			console.log("doAssembleControlNewTransformEntry " + stack.toString() + " " + stack.length);

			var node = getNodeFromStack(id, stack);

			var listEntry = new Object();
			var transform = new Object();
			transform.type = "translate";
			transform.x = "0";
			transform.y = "0";
	
			listEntry.transform = transform
			node.push(listEntry);

			doSelectAssemble(id);
			doRunAssemble(id);
		}

		function doClearControls() {
			var currentControls = document.getElementById("currentControls");

			var childNodes = currentControls.childNodes
			var i;
			for (i = (childNodes.length - 1);i >= 0;i--) {
				var node = childNodes[i];
				node.parentNode.removeChild(node);
			}

			delete gkToolContext.currentTransformXId;
			delete gkToolContext.currentTransformYId;
			delete gkToolContext.currentTransformAngleId;
			delete gkToolContext.currentTransformStack;
			delete gkToolContext.currentTransformId;
			delete this.currentTransformIndex1;
			delete this.currentTransformIndex2;
			delete this.currentTransformIndex3;
		}

		function doMouseDown(evt) {
			if (!gkToolContext.mouseDown) {
				if (gkToolContext.currentMouseMoveX == evt.clientX) {
					if (gkToolContext.currentMouseMoveY == evt.clientY) {
						gkToolContext.mouseTwiceDown = true;
					}
				}
			}
			gkToolContext.currentMouseMoveX = evt.clientX;
			gkToolContext.currentMouseMoveY = evt.clientY;
			gkToolContext.mouseDown = true;
		}

		function doMouseUp(evt) {
			gkToolContext.currentMouseMoveX = evt.clientX;
			gkToolContext.currentMouseMoveY = evt.clientY;
			gkToolContext.mouseDown = false;
			gkToolContext.mouseTwiceDown = false;
		}

		function doMouseMove(evt) {
			if (gkToolContext.mouseDown || gkToolContext.mouseTwiceDown) {
				if (gkToolContext.currentTransformXId != undefined) {
					var diffX = evt.clientX - gkToolContext.currentMouseMoveX;
					var diffY = evt.clientY - gkToolContext.currentMouseMoveY;

//console.log("diffX: " + diffX);
					if (gkToolContext.mouseTwiceDown) {
						if (gkToolContext.currentTransformStack != undefined) {
							doMouseMoveTwiceDownAssemble(evt, diffX, diffY);
						}
						if (gkToolContext.currentTransformIndex1 != undefined) {
							doMouseMoveTwiceDownAnimate(evt, diffX, diffY);
						}
					} else {
						if (gkToolContext.currentTransformStack != undefined) {
							doMouseMoveOnceDownAssemble(evt, diffX, diffY);
						}
						if (gkToolContext.currentTransformIndex1 != undefined) {
							doMouseMoveOnceDownAnimate(evt, diffX, diffY);
						}
					}
				}
			}
		}

		function doMouseMoveTwiceDownAssemble(evt, diffX, diffY) {
			var inputAngle = document.getElementById(gkToolContext.currentTransformAngleId);
			inputAngle.value = parseInt(inputAngle.value) + diffX;

			gkToolContext.currentMouseMoveX = evt.clientX;
			gkToolContext.currentMouseMoveY = evt.clientY;

			var node = getNodeFromStack(gkToolContext.currentTransformId, gkToolContext.currentTransformStack);
			node.angle = inputAngle.value;

			doRunAssemble(gkToolContext.currentTransformId);
		}

		function doMouseMoveTwiceDownAnimate(evt, diffX, diffY) {
			var inputAngle = document.getElementById(gkToolContext.currentTransformAngleId);
			inputAngle.value = parseInt(inputAngle.value) + diffX;

			gkToolContext.currentMouseMoveX = evt.clientX;
			gkToolContext.currentMouseMoveY = evt.clientY;

			var transformEntry = getAnimateTransformEntry(gkToolContext.currentTransformId, gkToolContext.currentTransformIndex1, gkToolContext.currentTransformIndex2, gkToolContext.currentTransformIndex3);

			transformEntry.transform.angle = inputAngle.value;

			//doRunAnimate(gkToolContext.currentTransformId);
			animateSvgDoSingle(gkToolContext.currentTransformId, gkToolContext.currentTransformIndex1);
		}

		function doMouseMoveOnceDownAssemble(evt, diffX, diffY) {
			var node = getNodeFromStack(gkToolContext.currentTransformId, gkToolContext.currentTransformStack);

			if (node.type == "scale") {
				diffX = diffX / 50;
				diffY = diffY / 50;
			}
			var inputX = document.getElementById(gkToolContext.currentTransformXId);
			inputX.value = parseFloat(inputX.value) + diffX;
			inputX.value = Math.round(inputX.value * 10) / 10;
			var inputY = document.getElementById(gkToolContext.currentTransformYId);
			inputY.value = parseFloat(inputY.value) + diffY;
			inputY.value = Math.round(inputY.value * 10) / 10;

			gkToolContext.currentMouseMoveX = evt.clientX;
			gkToolContext.currentMouseMoveY = evt.clientY;

			node.x = inputX.value;
			node.y = inputY.value;
			doRunAssemble(gkToolContext.currentTransformId);
		}

		function doMouseMoveOnceDownAnimate(evt, diffX, diffY) {
//			var node = getNodeFromStack(gkToolContext.currentTransformId, gkToolContext.currentTransformStack);

			var transformEntry = getAnimateTransformEntry(gkToolContext.currentTransformId, gkToolContext.currentTransformIndex1, gkToolContext.currentTransformIndex2, gkToolContext.currentTransformIndex3);

			if (transformEntry.transform.type == "scale") {
				diffX = diffX / 50;
				diffY = diffY / 50;
			}
			var inputX = document.getElementById(gkToolContext.currentTransformXId);
			inputX.value = parseFloat(inputX.value) + diffX;
			inputX.value = Math.round(inputX.value * 10) / 10;
			var inputY = document.getElementById(gkToolContext.currentTransformYId);
			inputY.value = parseFloat(inputY.value) + diffY;
			inputY.value = Math.round(inputY.value * 10) / 10;

			gkToolContext.currentMouseMoveX = evt.clientX;
			gkToolContext.currentMouseMoveY = evt.clientY;

			transformEntry.transform.x = inputX.value;
			transformEntry.transform.y = inputY.value;
		//	doRunAnimate(gkToolContext.currentTransformId);
			animateSvgDoSingle(gkToolContext.currentTransformId, gkToolContext.currentTransformIndex1);
		}

	</script>

	<style type="text/css">
		.whole {
		}
		#currentControls {
			background-color: #efefef;
			width: 95%;
		}
		#assembleList {
			width: 19%;
			float: left;
			background-color: #dfffdf;
		}
		#animateList {
			width: 19%;
			float: left;
			background-color: #ffefef;
		}
		.svgObjects {
			width: 19%;
			float: left;
			background-color: #efefff;
		}
		.assembleObjects {
			width: 19%;
			float: left;
			background-color: #dfffff;
		}
		.animateObjects {
			width: 19%;
			float: left;
			background-color: #ffffcf;
		}
		.trailer {
			clear: both;
		}
	</style>

	</head>

	<body onload="init();">
<div onmousedown="doMouseDown(event);" onmouseup="doMouseUp(event);" onmousemove="doMouseMove(event);">
<svg
    id="gkField"
    xmlns="http://www.w3.org/2000/svg"
    xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
    xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
    version="1.1"
    inkscape:version="0.48.2 r9819"
    sodipodi:docname="baby whatnot slice setup.svg"
    xmlns:i="http://ns.adobe.com/AdobeIllustrator/10.0/"
    xmlns:dc="http://purl.org/dc/elements/1.1/"
    xmlns:cc="http://creativecommons.org/ns#"
    xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
    xmlns:svg="http://www.w3.org/2000/svg"
    xmlns:xlink="http://www.w3.org/1999/xlink"
    x="0px"
    y="0px"
    width="800"
    height="400"
    xml:space="preserve">

<defs id="piecesGroup"></defs>
<g id="assembleGroup"></g>

</svg>		
</div>
	<br/>
		<span id="browserCompatible">one</span>
		<input type="file" id="files" name="files[]" multiple/><br/>
		<a id="downloadAssemble">download saved assembly</a><br/>
		<a id="downloadAnimate">download saved animation</a><br/>

		<form onsubmit="return false;">
		<div class="whole">
			<div id="currentControls">
			</div>
		</div>
		<div class="whole">
			<div id="assembleList">
			</div>
			<div id="animateList">
			</div>
			<div class="assembleObjects">
				<input id="createAssembleId" size="8" type="text"/><input type="submit" onclick="doCreateAssemble();" value="Create Assembly"/><br/>
				<ul id="assembleObjects">
				</ul>
			</div>
			<div class="animateObjects">
				<input id="createAnimateId" size="8" type="text"/><input type="submit" onclick="doCreateAnimate();" value="Create Animation"/><br/>
				<ul id="animateObjects">
				</ul>
			</div>
			<div class="svgObjects">
				<ul id="svgObjects"></ul>
			</div>
		</div>
		</form>
		<div class="trailer">
<p>The svg sanitizer tool can be found <a href="http://www.gourdianknot.com/gktool/utils">here</a>.</p>
		</div>
	<div class="gkGameFooter">Gourdian Knot pre-alpha release 0.2.10 <a href="http://www.gourdianknot.com">Gourdian Knot Main Page</a></div>
	</body>

</html>

